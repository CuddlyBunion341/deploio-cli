#!/usr/bin/env bash
set -euo pipefail
APP_NAME=${APP_NAME:-deploio}
INSTALL_DIR=${INSTALL_DIR:-"${HOME}/.local/bin"}
RAW_BASE=${RAW_BASE:-"https://raw.githubusercontent.com/CuddlyBunion341/deploio-cli/main"}
CLI_URL="${RAW_BASE}/deploio"
COLOR_RESET='\033[0m'
COLOR_GREEN='\033[0;32m'
COLOR_YELLOW='\033[0;33m'
COLOR_CYAN='\033[0;36m'
COLOR_RED='\033[0;31m'
print() { printf "%b\n" "$*"; }
info() { print "${COLOR_CYAN}$*${COLOR_RESET}"; }
success() { print "${COLOR_GREEN}$*${COLOR_RESET}"; }
warn() { print "${COLOR_YELLOW}$*${COLOR_RESET}"; }
err() { print "${COLOR_RED}$*${COLOR_RESET}" 1>&2; }
have_cmd() { command -v "$1" >/dev/null 2>&1; }
fetch() {
  local url="$1" dest="$2"
  if have_cmd curl; then
    curl -fsSL "$url" -o "$dest"
  elif have_cmd wget; then
    wget -qO "$dest" "$url"
  else
    err "Need curl or wget to download: $url"
    return 1
  fi
}
main() {
  info "Installing ${APP_NAME} (deplo.io app CLI)"
  mkdir -p "$INSTALL_DIR"
  tmp_file="$(mktemp -t ${APP_NAME}.XXXXXX)"
  trap 'rm -f "$tmp_file"' EXIT
  info "Downloading from: $CLI_URL"
  if ! fetch "$CLI_URL" "$tmp_file"; then
    err "Failed to download ${APP_NAME} from $CLI_URL"
    exit 1
  fi
  install_path="${INSTALL_DIR}/${APP_NAME}"
  mv "$tmp_file" "$install_path"
  chmod +x "$install_path"
  # Create shorthand symlink 'depl'
  (cd "$INSTALL_DIR" && ln -sf "$APP_NAME" depl)
  success "Installed ${APP_NAME} to ${install_path}"
  case ":${PATH}:" in
    *":${INSTALL_DIR}:"*) ;;
    *)
      warn "${INSTALL_DIR} is not on your PATH. Add this to your ~/.zshrc:"
      echo ""
      echo "  export PATH=\"$INSTALL_DIR:\$PATH\""
      echo ""
      echo "Then reload your shell:"
      echo "  source ~/.zshrc"
      ;;
  esac
  echo ""
  info "Test the installation:"
  echo "  ${APP_NAME} --dry-run list"
}
main "$@"
